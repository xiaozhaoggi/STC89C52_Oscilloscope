#include "lcd.h"
#include <intrins.h>

#define LCDDelay() {_nop_();}
//struct Char57TypeDef code Char57[];
const Uchar delay=250; //延时时间常数
struct Char57TypeDef code Char57[] =         // ASCII
{
	" ",
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // - -
	"!",
	0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00, // -!-
	"\"",
	0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00, // -"-
	"#",
	0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x00, // -#-
	"$",
	0x20,0x78,0xC0,0x70,0x28,0xF0,0x20,0x00, // -$-
	"%",
	0xC0,0xC8,0x10,0x20,0x40,0x98,0x18,0x00, // -%-
	"&",
	0x40,0xA0,0xA0,0x40,0xA8,0x90,0x68,0x00, // -&-
	"'",
	0x30,0x20,0x40,0x00,0x00,0x00,0x00,0x00, // -'-
	"(",
	0x10,0x20,0x40,0x40,0x40,0x20,0x10,0x00, // -(-
	")",
	0x40,0x20,0x10,0x10,0x10,0x20,0x40,0x00, // -)-
	"*",
	0x20,0xA8,0x70,0x20,0x70,0xA8,0x20,0x00, // -*-
	"+",
	0x20,0x20,0x20,0xF8,0x20,0x20,0x20,0x00, // -+-
	",",
	0x00,0x00,0x00,0x00,0x60,0x40,0x80,0x00, // -,-
	"-",
	0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00, // ---
	".",
	0x00,0x00,0x00,0x00,0x00,0x60,0x60,0x00, // -.-
	"/",
	0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00, // -/-
	"0",
	0x70,0x88,0x98,0xA8,0xC8,0x88,0x70,0x00, // -0-
	"1",
	0x20,0x60,0x20,0x20,0x20,0x20,0x70,0x00, // -1-
	"2",
	0x70,0x88,0x08,0x30,0x40,0x80,0xF8,0x00, // -2-
	"3",
	0xF8,0x08,0x10,0x30,0x08,0x88,0x70,0x00, // -3-
	"4",
	0x10,0x30,0x50,0x90,0xF8,0x10,0x10,0x00, // -4-
	"5",
	0xF8,0x80,0xF0,0x08,0x08,0x88,0x70,0x00, // -5-
	"6",
	0x38,0x40,0x80,0xF0,0x88,0x88,0x70,0x00, // -6-
	"7",
	0xF8,0x08,0x10,0x20,0x40,0x40,0x40,0x00, // -7-
	"8",
	0x70,0x88,0x88,0x70,0x88,0x88,0x70,0x00, // -8-
	"9",
	0x70,0x88,0x88,0x78,0x08,0x10,0xE0,0x00, // -9-
	":",
	0x00,0x60,0x60,0x00,0x60,0x60,0x00,0x00, // -:-
	";",
	0x00,0x60,0x60,0x00,0x60,0x60,0x80,0x00, // -;-
	"<",
	0x10,0x20,0x40,0x80,0x40,0x20,0x10,0x00, // -<-
	"=",
	0x00,0x00,0xF8,0x00,0xF8,0x00,0x00,0x00, // -=-
	">",
	0x40,0x20,0x10,0x08,0x10,0x20,0x40,0x00, // ->-
	"?",
	0x70,0x88,0x10,0x20,0x20,0x00,0x20,0x00, // -?-
	"@",
	0x70,0x88,0xB8,0xA8,0xB8,0x80,0x78,0x00, // -@-
	"A",
	0x20,0x50,0x88,0x88,0xF8,0x88,0x88,0x00, // -A-
	"B",
	0xF0,0x88,0x88,0xF0,0x88,0x88,0xF0,0x00, // -B-
	"C",
	0x70,0x88,0x80,0x80,0x80,0x88,0x70,0x00, // -C-
	"D",
	0xF0,0x88,0x88,0x88,0x88,0x88,0xF0,0x00, // -D-
	"E",
	0xF8,0x80,0x80,0xF0,0x80,0x80,0xF8,0x00, // -E-
	"F",
	0xF8,0x80,0x80,0xF0,0x80,0x80,0x80,0x00, // -F-
	"G",
	0x70,0x88,0x80,0x80,0xB8,0x88,0x78,0x00, // -G-
	"H",
	0x88,0x88,0x88,0xF8,0x88,0x88,0x88,0x00, // -H-
	"I",
	0x70,0x20,0x20,0x20,0x20,0x20,0x70,0x00, // -I-
	"J",
	0x38,0x10,0x10,0x10,0x10,0x90,0x60,0x00, // -J-
	"K",
	0x88,0x90,0xA0,0xC0,0xA0,0x90,0x88,0x00, // -K-
	"L",
	0x80,0x80,0x80,0x80,0x80,0x80,0xF8,0x00, // -L-
	"M",
	0x88,0xD8,0xA8,0xA8,0x88,0x88,0x88,0x00, // -M-
	"N",
	0x88,0x88,0xC8,0xA8,0x98,0x88,0x88,0x00, // -N-
	"O",
	0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00, // -O-
	"P",
	0xF0,0x88,0x88,0xF0,0x80,0x80,0x80,0x00, // -P-
	"Q",
	0x70,0x88,0x88,0x88,0xA8,0x90,0x68,0x00, // -Q-
	"R",
	0xF0,0x88,0x88,0xF0,0xA0,0x90,0x88,0x00, // -R-
	"S",
	0x70,0x88,0x80,0x70,0x08,0x88,0x70,0x00, // -S-
	"T",
	0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x00, // -T-
	"U",
	0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00, // -U-
	"V",
	0x88,0x88,0x88,0x88,0x88,0x50,0x20,0x00, // -V-
	"W",
	0x88,0x88,0x88,0xA8,0xA8,0xD8,0x88,0x00, // -W-
	"X",
	0x88,0x88,0x50,0x20,0x50,0x88,0x88,0x00, // -X-
	"Y",
	0x88,0x88,0x50,0x20,0x20,0x20,0x20,0x00, // -Y-
	"Z",
	0xF8,0x08,0x10,0x20,0x40,0x80,0xF8,0x00, // -Z-
	"[",
	0xF0,0xC0,0xC0,0xC0,0xC0,0xC0,0xF0,0x00, // -[-
	"\\",
	0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00, // -\-
	"]",
	0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00, // -]-
	"^",
	0x20,0x70,0xA8,0x20,0x20,0x20,0x20,0x00, // -^-
	"_",
	0x00,0x20,0x40,0xF8,0x40,0x20,0x00,0x00, // -_-
	"`",
	0x20,0x10,0x08,0x00,0x00,0x00,0x00,0x00, // -`-
	"a",
	0x00,0x00,0xE0,0x10,0x70,0x90,0x68,0x00, // -a-
	"b",
	0x80,0x80,0xB0,0xC8,0x88,0xC8,0xB0,0x00, // -b-
	"c",
	0x00,0x00,0x70,0x88,0x80,0x80,0x70,0x00, // -c-
	"d",
	0x08,0x08,0x68,0x98,0x88,0x98,0x68,0x00, // -d-
	"e",
	0x00,0x00,0x70,0x88,0xF0,0x80,0x70,0x00, // -e-
	"f",
	0x30,0x48,0x40,0xF0,0x40,0x40,0x40,0x00, // -f-
	"g",
	0x00,0x00,0x70,0x88,0x88,0x78,0x08,0xF0, // -g-
	"h",
	0x80,0x80,0xB0,0xC8,0x88,0x88,0x88,0x00, // -h-
	"i",
	0x20,0x00,0x00,0x20,0x20,0x20,0x20,0x00, // -i-
	"j",
	0x10,0x00,0x00,0x30,0x10,0x10,0x10,0x60, // -j-
	"k",
	0x80,0x80,0x90,0xA0,0xC0,0xA0,0x98,0x00, // -k-
	"l",
	0x60,0x20,0x20,0x20,0x20,0x20,0x70,0x00, // -l-
	"m",
	0x00,0x00,0x50,0xA8,0xA8,0xA8,0xA8,0x00, // -m-
	"n",
	0x00,0x00,0xB0,0x48,0x48,0x48,0x48,0x00, // -n-
	"o",
	0x00,0x00,0x70,0x88,0x88,0x88,0x70,0x00, // -o-
	"p",
	0x00,0x00,0xF0,0x88,0x88,0xF0,0x80,0x80, // -p-
	"q",
	0x00,0x00,0x78,0x88,0x88,0x78,0x08,0x08, // -q-
	"r",
	0x00,0x00,0xB0,0x48,0x40,0x40,0x40,0x00, // -r-
	"s",
	0x00,0x00,0x78,0x80,0x70,0x08,0xF0,0x00, // -s-
	"t",
	0x40,0x40,0xF8,0x40,0x40,0x48,0x30,0x00, // -t-
	"u",
	0x00,0x00,0x90,0x90,0x90,0x90,0x68,0x00, // -u-
	"v",
	0x00,0x00,0x88,0x88,0x88,0x50,0x20,0x00, // -v-
	"w",
	0x00,0x00,0xA8,0xA8,0xA8,0xA8,0x50,0x00, // -w-
	"x",
	0x00,0x00,0x88,0x50,0x20,0x50,0x88,0x00, // -x-
	"y",
	0x00,0x00,0x88,0x88,0x98,0x68,0x08,0xF0, // -y-
	"z",
	0x00,0x00,0xF8,0x10,0x20,0x40,0xF8,0x00, // -z-
	"{",
	0x20,0x40,0x40,0x80,0x40,0x40,0x20,0x00, // -{-
	"|",
	0x20,0x20,0x20,0x00,0x20,0x20,0x20,0x00, // -|-
	"}",
	0x20,0x10,0x10,0x08,0x10,0x10,0x20,0x00, // -}-
	"~",
	0x00,0x00,0x40,0xA8,0x10,0x00,0x00,0x00, // -~-
};

static void Wait1ms(void)//延迟1 ms
{
Uchar cnt=0;
while (cnt<delay) cnt++;
}

//延迟n ms
void WaitNms(int n)
{
Uchar i;
for(i=1;i<=n;i++)
Wait1ms();
}

/* 12864液晶忙状态检测检测函数 */
void LcdWaitReady()
{
    unsigned char sta;
    
    LCD12864_DB = 0xFF;
	_nop_();
    LCD12864_RS = 0;
	_nop_();
    LCD12864_RW = 1;
	_nop_();
    do {
		LCD12864_E = 1;
		LCDDelay();
		sta = LCD12864_DB;
		LCDDelay();
		LCD12864_E = 0;
		LCDDelay();
    } while (sta & 0x80);		//bit7等于1表示液晶正忙，重复检测直到其等于0为止
}

/* 向液晶写入一字节命令，cmd-待写入命令值 */
void LcdWriteCmd(unsigned char cmd)
{
    LcdWaitReady();
    LCD12864_RS = 0;
	_nop_();
    LCD12864_RW = 0;
	_nop_();
    LCD12864_DB = cmd;
	_nop_();
    LCD12864_E  = 1;
	LCDDelay();
    LCD12864_E  = 0;
	LCDDelay();
}

/* 向液晶写入一字节数据，dat-待写入数据值 */
void LcdWriteDat(unsigned char dat)
{
    LcdWaitReady();
    LCD12864_RS = 1;
	_nop_();
    LCD12864_RW = 0;
	_nop_();
    LCD12864_DB = dat;
	_nop_();
    LCD12864_E  = 1;
	LCDDelay();
    LCD12864_E  = 0;
	LCDDelay();
}

/* 从液晶读出一字节数据，dat-读出的数据值 */
unsigned char LcdReadDat()
{
	unsigned char dat;
    LcdWaitReady();
    LCD12864_RS = 1;
	_nop_();
    LCD12864_RW = 1;
	_nop_();
    LCD12864_E  = 1;
	LCDDelay();
    dat = LCD12864_DB;
	LCDDelay();
    LCD12864_E  = 0;
	LCDDelay();
	return dat;
}

/*
* 函数名：LcdShowString
* 描  述：在显示屏上显示一串字符串
* 输  入：str	- 待显示字符串指针
*         x		- 屏幕显示横坐标(以像素为单位)
*         y		- 屏幕显示纵坐标(以像素为单位)
* 输  出：无
* 备  注：输入的字符串必须符合C语言规范，即以'\0'-NULL为结束标识；
*         x、y坐标必须是16的整数倍，因DDRAM地址以全角字符(16*16pixel)为单位。
*/
void LcdShowString(unsigned char x, unsigned char y, unsigned char *str)
{
    unsigned char addr;
    
    //由输入的显示坐标计算DDRAM的地址
    x >>= 4;					//等价于除以16(换算坐标0～7)
    y >>= 4;
    if (y >= 2)
    {
        y -= 2;
        x += 8;
    }
    addr = y*16 + x;
    //由起始DDRAM地址连续写入字符串
    LcdWriteCmd(0x30);			//启动DDRAM操作(基本指令操作)
    LcdWriteCmd(0x80|addr);
    while (*str != '\0')
    {
        LcdWriteDat(*str);
        str++;
    }
}

/*
* 函数名：LcdShowImage
* 描  述：在显示屏上显示一幅图像
* 输  入：img - 待显示图像指针
*         x - 屏幕显示横坐标(以像素为单位)
*         y - 屏幕显示纵坐标(以像素为单位)
*         w - 图像宽度(以像素为单位)
*         h - 图像高度(以像素为单位)
* 输  出：无
* 备  注：x与w必须是16的整数倍，因CGRAM最小寻址单位为2字节；y与h可为0-63的任意值。
*/
void LcdShowImage(unsigned char x, unsigned char y, unsigned char w, unsigned char h, unsigned char *img)
{
    unsigned int i;
    unsigned char xi,yi;
    unsigned char xt,yt;

    x >>= 4;					//等价于除以16(换算坐标0～7)
    w >>= 3;					//等价于除以8(换算宽度1～16)
    i = 0;
    LcdWriteCmd(0x36);			//启动CGRAM操作(扩充指令操作，打开图形显示)
    for (yi=0; yi<h; yi++)
    {
        yt = y+yi;
        xt = x;
        if (yt >= 32)
        {
            yt -= 32;
            xt += 8;
        }
        LcdWriteCmd(0x80|yt);	//设置纵坐标
        LcdWriteCmd(0x80|xt);	//设置横坐标
        for (xi=0; xi<w; xi++)
            LcdWriteDat(img[i++]);
    }
}

/*
* 函数名：LcdShowPoint
* 描  述：在显示屏上指定位置打点
* 输  入：
*         x - 屏幕显示横坐标(以像素为单位，范围0～127)
*         y - 屏幕显示纵坐标(以像素为单位，范围0～63)
*        sn - 为1时画实点，为0时画空点
* 输  出：无
* 备  注：
*/
void LcdShowPoint(unsigned char x, unsigned char y, bit sn)
{
    unsigned char xi, dat1, dat2;
	
	if (y >= 32)
	{
		y -= 32;
		x += 128;
	}
	xi = x % 16;							//计算点的16位数的坐标位置
	x /= 16;								//计算点所在的字节地址
    LcdWriteCmd(0x36);						//启动CGRAM操作(扩充指令操作，打开图形显示)
	LcdWriteCmd(0x80|y);					//设置纵坐标
	LcdWriteCmd(0x80|x);					//设置横坐标
	LcdReadDat();							//注意：读取的第一个数据不要（是地址？）
	dat1 = LcdReadDat();					//读取屏幕数据
	dat2 = LcdReadDat();
	
	if (xi < 8)								//将点的数据添加进屏幕数据
		if (sn ==1)
			dat1 |= 0x80 >> xi;				//画实点
		else
			dat1 &= _cror_(0x7F, xi);		//画空点
	else
		if (sn == 1)
			dat2 |= 0x80 >> (xi - 8);		//画实点
		else
			dat2 &= _cror_(0x7F, xi - 8);	//画空点
	
	LcdWriteCmd(0x80|y);					//设置纵坐标
	LcdWriteCmd(0x80|x);					//设置横坐标
	LcdWriteDat(dat1);						//屏幕打点
	LcdWriteDat(dat2);
}

/* 5X7字符串显示函数 */
unsigned char LcdWriteChar57(unsigned char x, unsigned char y, unsigned char *cn)
{
	unsigned char wordNum, xi, yi;
	unsigned char cnNum = sizeof(Char57)/9;							//字库总字数

	if(x<0 || x>127)												//x坐标只能从0到127，否则直接返回
		return 0;

	if(y<0 || y>56)													//y坐标只能从0到56，否则直接返回
		return 0;

	while (*cn != '\0')												//在C语言中字符串以'\0'结尾
	{
		for (wordNum=0; wordNum<cnNum; wordNum++)
		{
		    //--查询要写的字在字库中的位置--//
			if (Char57[wordNum].Index[0] == *cn)
			{
				for (yi=0; yi<8; yi++)								//字符高为8像素(第8行像素为空行)
					for (xi = 0; xi < 6; xi++)						//字符宽为6像素(第6列像素为空列)
						if (Char57[wordNum].Msk[yi] & 0x80 >> xi)
							LcdShowPoint(x+xi, y+yi, 1);
						else
							LcdShowPoint(x+xi, y+yi, 0);
				break;
			}				//if查字结束		
		}					//for查字结束
		cn++;
		x += 6;
	}						//while结束
	return 1;
}

/*
* 函数名：LcdClearArea
* 描  述：清除屏幕上的一块图形显示区域
* 输  入：x - 区域起始横坐标(以像素为单位)
*		  y - 区域起始纵坐标(以像素为单位)
*		  w - 区域宽度(以像素为单位)
*		  h - 区域高度(以像素为单位)
* 输  出：无
* 备  注：x与w必须是16的整数倍，因CGRAM最小寻址单位为2字节；y与h可为0-63的任意值。
*/
void LcdClearArea(unsigned char x, unsigned char y, unsigned char w, unsigned char h)
{
    unsigned char xi,yi;
    unsigned char xt,yt;

    x >>= 4;
    w >>= 3;
    LcdWriteCmd(0x36);			//启动CGRAM操作
    for (yi=0; yi<h; yi++)
    {
        yt = y+yi;
        xt = x;
        if (yt >= 32)
        {
            yt -= 32;
            xt += 8;
        }
        LcdWriteCmd(0x80|yt);
        LcdWriteCmd(0x80|xt);
        for (xi=0; xi<w; xi++)
			LcdWriteDat(0x00);	//清屏（写入空字符）
    }
}

/* 12864液晶初始化函数 */
void InitLcd12864()
{
	unsigned char x, y;
//	LCD_PSB = 1;				//并口方式
	LCD_RST = 0;				//液晶复位
	for(x=0;x<5;x++)			//延时
		for(y=0;y<123;y++);
	LCD_RST = 1;
	for(x=0;x<5;x++)			//延时
		for(y=0;y<123;y++);

    //字符模式初始化
    LcdWriteCmd(0x30);			//基本指令集
    LcdWriteCmd(0x01);			//清零字符显示
    LcdWriteCmd(0x02);			//地址归位
    LcdWriteCmd(0x0C);			//开显示
    
    //图形模式初始化
    LcdWriteCmd(0x34);			//启动扩展指令，关闭图形显示
    for (y=0; y<32; y++)		//清零图形显示缓冲区
    {
        LcdWriteCmd(0x80|y);
        LcdWriteCmd(0x80|0);
        for (x=0; x<32; x++)
            LcdWriteDat(0x00);
    }
    LcdWriteCmd(0x36);			//开启图形模式显示
}



